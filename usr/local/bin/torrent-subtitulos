#!/bin/bash
#
#	busca subtitulos
#

NOMBRE="$1"

IMDB="$2"
MD5SUB=$(echo "$NOMBRE" | md5sum | cut -d" " -f1)
ARCHIVO="$HOME/.cache/sub/$MD5SUB"

#NOMBRELIMPIO=$(echo $NOMBRE | sed 's/[^a-zA-Z0-9\ ]//g; s/....$//')
NOMBRELIMPIO=$(echo $NOMBRE | sed 's/....$//')

function elegir {
	echo "$*"  | sort -uR | cut -d'[' -f1 | sed 's/[^0-9]//g' | head -n1
}

function mensaje {
	echo "$*" >> /tmp/info
}

mkdir -p ~/.cache/sub/
cd $(mktemp -d)

touch "$NOMBRE" &

# ID en imbd (convertir en un programa)
if [ "$IMDB" == "" ] ; then
	#nombre del torrent
	BUSQUEDA=$(echo "$NOMBRE" | sed 's/....$//; s/\./ /g; s/\(\(19\|20\)[0-9][0-9]\).*$/\1/g'  | cut -d')' -f1 | cut -d'-' -f1 | sed "s/^ *//g; s/ *$//; s/\ /%20/g")
	IMDB=$(lynx https://www.startpage.com/do/m/mobilesearch?q=${BUSQUEDA}%20host%3Aimdb.com -dump -nonumbers | grep "^http://www.imdb.com" | cut -d/ -f5 | sort -u | grep "^tt" | head -n1 | sed 's/[^0-9]//g')
fi

# descarga el subtitulo
#subdl --lang=spa "$NOMBRE" || subdl --lang=spa --imdb-id="$IMDB" --force-imdb "$NOMBRE" 2> /dev/null 1> /dev/null

LISTA=$(subdl --download=none --lang=spa --imdb-id=$IMDB --force-imdb "$NOMBRE" 2> /dev/null \
| grep srt | grep -v '^$')

# eleccion con el nombre mas corto
IDD=$(elegir "$(echo "$LISTA" | grep "$NOMBRELIMPIO")")
NOMBRELIMPIO=$(echo $NOMBRE | sed 's/[^a-zA-Z0-9\ ]//g; s/....$//')
[ "$IDD" == "" ] && IDD=$(elegir "$(echo "$LISTA" | grep "$NOMBRELIMPIO")")
[ "$IDD" == "" ] && IDD=$(elegir "$LISTA")

# descarga el subtitulo
subdl --lang=spa --imdb-id="$IMDB" --download="$IDD" --force-imdb "$NOMBRE" 2> /dev/null 1> /dev/null

rm "$NOMBRE"

[ "$(ls)" == "" ] && exit
echo $ARCHIVO

rename 's/[^0-9a-zA-Z]//g' *
L="$(ls)"

#mensaje "Subtitulo $L"	#debug
#mensaje "Pelicula $NOMBRE"	#debug

mensaje "Mejorando subtitulos..."

# codifica todo en UTF8
cat $L | grep á || recode latin1..utf8 $L


# quitar la publicidad

sed -i "/OpenSubtitles\.org/d; \
/Apoyanos y convierte/d; \
/remover todos los anuncios/d; \
/Anuncie su producto o marca/d; \
/Downloaded/d; \
s/#\(\ \|$\)/♪\1/g; s/#.$/♫/g; \
/AllSubs.org/d;" $L

mensaje "Subtitulos completos"

mv "$L" "$ARCHIVO"

exit
