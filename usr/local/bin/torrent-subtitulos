#!/bin/bash
#
#	busca subtitulos
#

NOMBRE="$1"

IMDB="$2"
MD5SUB=$(echo "$NOMBRE" | md5sum | cut -d" " -f1)
ARCHIVO="$HOME/.cache/sub/$MD5SUB"

#NOMBRELIMPIO=$(echo $NOMBRE | sed 's/[^a-zA-Z0-9\ ]//g; s/....$//')
NOMBRELIMPIO=$(echo $NOMBRE | sed 's/....$//')

function elegir {
	echo "$*"  | sort -uR | cut -d'[' -f1 | sed 's/[^0-9]//g' | head -n1
}

function mensaje {
	echo "$*" >> /tmp/info
}

mensaje "Buscando subtitulos $IMDB"
mkdir -p ~/.cache/sub/
cd $(mktemp -d)

touch "$NOMBRE" &

# busca el imdb si no lo tiene
[ "$IMDB" == "" ] && IMDB=(torrent-imdb "$NOMBRE")

# descarga el subtitulo
#subdl --lang=spa "$NOMBRE" || subdl --lang=spa --imdb-id="$IMDB" --force-imdb "$NOMBRE" 2> /dev/null 1> /dev/null

LISTA=$(subdl --download=none --lang=spa --imdb-id=$IMDB --force-imdb "$NOMBRE" 2> /dev/null \
| grep srt | grep -v '^$')

# eleccion con el nombre mas corto
IDD=$(elegir "$(echo "$LISTA" | grep "$NOMBRELIMPIO")")
NOMBRELIMPIO=$(echo $NOMBRE | sed 's/[^a-zA-Z0-9\ ]//g; s/....$//')
[ "$IDD" == "" ] && IDD=$(elegir "$(echo "$LISTA" | grep "$NOMBRELIMPIO")")
[ "$IDD" == "" ] && IDD=$(elegir "$LISTA")

# descarga el subtitulo
subdl --lang=spa --imdb-id=$IMDB --download="$IDD" --force-imdb "$NOMBRE" 2> /dev/null 1> /dev/null

rm "$NOMBRE"

[ "$(ls)" == "" ] && exit
mensaje "Subtitulos encontrados"
echo $ARCHIVO

rename 's/[^0-9a-zA-Z]//g' *
L="$(ls)"

#mensaje "$LISTA"	#debug
#mensaje "Subtitulo $L"	#debug
#mensaje "Pelicula $NOMBRE"	#debug

#Mensaje "Mejorando subtitulos..."

# codifica todo en UTF8 - falta detectar el formato original
[ "$(cat $L | grep é)" == "" ] &&  (recode $(file -i "$L" |cut -d'=' -f2)..utf8 $L || recode latin1..utf8 $L)
[ ! "$(cat $L | grep Ã)" == "" ] && mensaje "problemas de codificación"
# esto tiene fallas todavia

# quitar la publicidad

sed -i "s/^.*OpenSubtitles\.org.*$/.../g; \
s/^Apoyanos y convierte.*$/.../g; \
s/^.*remover todos los anuncios.*$/.../g; \
s/^Anuncie su producto o marca.*$/.../g; \
s/^Downloaded.*$/.../g; \
s/#\(\ \|$\|<\)/♪\1/g; s/#.$/♫/g; \
s/^.*AllSubs.org/.../g; " $L

#s/[^0-9A-Za-z<>\.\ ,\;\:\(\){}\#\@\$\¡\!¿?%&\"\-]//g; \


mv "$L" "$ARCHIVO"

exit
