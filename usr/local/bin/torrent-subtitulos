#!/bin/bash
#
#	busca subtitulos
#

NOMBRE="$1"
IMDB="$2"
MD5SUB=$(echo "$NOMBRE" | md5sum | cut -d" " -f1)

cd $(mktemp -d)

function mensaje {
        echo "$*" >> /tmp/info
}

# busca el imdb si no lo tiene
[ "$IMDB" == "" ] && IMDB=(torrent-imdb "$NOMBRE")

mensaje "Buscando subtitulos $IMDB"
mkdir -p ~/.cache/sub/$IMDB/
DIR="$HOME/.cache/sub/$IMDB/"

# baja todos los subtitulos
# mira cual es que ocupa mas tiempo
# y usa el mas largo (suelen ser los mejores)
touch "$NOMBRE" &
subdl --download=all --lang=spa --imdb-id=$IMDB --force-imdb "$NOMBRE"
rm "$NOMBRE"

[ "$(ls)" == "" ] && exit
mensaje "Subtitulos encontrados"

N=0
ls -S | while read L; do

# codifica todo en UTF8 - falta detectar el formato original
[ "$(cat "$L" | grep é)" == "" ] &&  (recode $(file -i "$L" |cut -d'=' -f2)..utf8 "$L" || recode latin1..utf8 "$L")
[ ! "$(cat "$L" | grep Ã)" == "" ] && mensaje "problemas de codificación"

# quitar la publicidad
sed -i "s/^.*OpenSubtitles\.org.*$/.../g; \
s/^Apoyanos y convierte.*$/.../g; \
s/^.*remover todos los anuncios.*$/.../g; \
s/^Anuncie su producto o marca.*$/.../g; \
s/^Downloaded.*$/.../g; \
s/#\(\ \|$\|<\)/♪\1/g; s/#.$/♫/g; \
s/^.*AllSubs.org/.../g;" "$L"

mv -v "$L" "$DIR/$N"
N=$((N=N+1))

done

exit

Quehaceres
==========

* verificar como levantar subtitulos adjuntos
* descargar todos y levantarlos con un switch
