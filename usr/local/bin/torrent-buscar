#!/bin/bash
#
#	torrent o magnet
#	$1: nombre	$2: imdb

rm /tmp/pares &

# generar un nombre|nombre| para diferentes idiomas
NOMBRE=$(echo $1 | sed 's/,\|\./ /g; s/[^a-zA-Z0-9\ -]//g; s/\ /+/g')
echo $NOMBRE > /dev/stderr
[ ! "$(head /tmp/$NOMBRE)" == "" ]&& cat /tmp/$NOMBRE && exit

[ "$2" == "" ] && IMDB=$(torrent-imdb "$NOMBRE") || IMDB=$2

#	falta:
#	tambien buscar sin años y sin acentos

HASH=$(echo "$NOMBRE+latino|español|spanish" | grep -vi "$NEGRA" | grep -i "$BLANCA" | head -n1 | cut -d"	" -f1)
[ ! "$HASH" == "" ] && echo "magnet:?xt=urn:btih:${HASH}"| tee /tmp/$NOMBRE && exit

# busca los subtitulos posibles para buscar los videos en torrentz
# esta lista puede ser guardada para subtitulos alternativos
mkdir /tmp/sub/
touch "/tmp/sub/$1" 2> /dev/null
subdl --download=none --lang=spa --imdb-id=$IMDB --force-imdb "/tmp/sub/$1" \
| cut -d '"' -f3 | grep \.srt | sed 's/\ *$//g; s/^\ //g; s/\....$//g;  s/\(\.|-\)...//g; s/\.[^\.]*$//' \
| grep ............* \
| grep -iv "cd\(\|.\)[1-2]" \
| while read SNOMBRE; do
	echo "probando con $SNOMBRE" >> /tmp/info
	# busca el nombre basado en los subtitulos
	BUSQUEDA=$(torrentz-dl "\"$SNOMBRE\"" peerflix)
	[ ! "$BUSQUEDA" == "" ] && echo -e "Subtitulos encontrados\nDescargando... $BUSQUEDA"  >> /tmp/info && break
done
# falta que tenga la mayor cantidad de pares

# busqueda normal y kickass por imdb
[ "$BUSQUEDA" == "" ] && BUSQUEDA=$([ ! "$IMDB" == "" ] && kickass-dl $IMDB; torrentz-dl "$NOMBRE" peerflix)

# sin el año
[ "$BUSQUEDA" == "" ] && BUSQUEDA=$(torrentz-dl $(echo "$NOMBRE" | sed 's/....$//') peerflix)
[ "$BUSQUEDA" == "" ] && exit # tal vez pueda reducir el nombre o buscar en youtube, vblog, etc


# busquedas mas filtros
# esto moverlo a .torrent-buscar/ o algo asi
NEGRA=$(cat ~/.negra)
BLANCA=$(cat ~/.blanca)
HASH=$(echo "BUSQUEDA" | grep -vi "$NEGRA" | grep -i "$BLANCA" | head -n1 | cut -d"	" -f1)

# busca solo filtrando la lista negra
[ "$HASH" == "" ] && HASH=$(echo "$BUSQUEDA" | grep -vi "$NEGRA" | head -n1 | cut -d"	" -f1)


# devuelve el hash y guarda el cache
[ ! "$HASH" == "" ] && echo "magnet:?xt=urn:btih:${HASH}"| tee /tmp/$NOMBRE

echo "Pares: $(echo "$BUSQUEDA" | grep $HASH | head -n1 | cut -d"	" -f2)" >> /tmp/info

echo "$BUSQUEDA" | grep $HASH | head -n1 | cut -d"       " -f2 > /tmp/pares


exit

Quehaceres
==========

* hacer una gran lista ordenada (X)
  * si no tiene o tiene subtitulo (X) no funciona tan bien :S
* si no encuentran nada en torrent levanta cosas en descarga directa


