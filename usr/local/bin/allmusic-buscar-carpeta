#!/bin/bash
#
#	http://www.allmusic.com/advanced-search
#	http://www.allmusic.com/genres
#	http://www.allmusic.com/genre/blues-ma0000002467/artists

#
#


# como se ve
PROGRAMA="torrent-buscar"

# comprobar si hay red
# carpeta para el cache
DIMDB="$HOME/.cache/imdb"
mkdir $DIMDB 2> /dev/null

MUSICA="$(xdg-user-dir MUSIC)"

function limpiar {
	echo $* | sed 's/^.*\///; s/-m.[0-9].*$//; s/-/\ /g; s/^./\u&/; s@+@ @g;s@%@\\x@g' | xargs -0 printf "%b"
}

lynx -dump -nonumbers http://www.allmusic.com/genres | grep "^http://www.allmusic.com/genre/" | sort -u | while read G; do
	# falta la primera letra
	GENERO=$(limpiar $G )
	mkdir -p "$MUSICA/$GENERO" 2> /dev/stderr
	lynx -dump -nonumbers $G/artists | grep "^http://www.allmusic.com/artist/" | sort -u | while read A; do
		# falta la primera letra
		ARTISTA=$(limpiar $A)
		mkdir -p "$MUSICA/Artistas/$ARTISTA" 2> /dev/stderr
		lynx -dump -nonumbers $A | grep "^http://www.allmusic.com/album/" | sort -u | while read D; do
			DISCO=$(limpiar $D)
			ID="$(echo $ARTISTA+$DISCO | md5sum | cut -d" " -f1)"
			# mirar
			IMG="$DIMDB/$ID.jpg"
		        if [ ! -f $IMG ]; then
        		        URL=$(lynx -dump "$D" -image_links -nonumbers | grep "^http.*\.jpg" | head -n1)
               			# descarga en hd si no puede en lw y si no, no genera el link, si da error continua
				echo $URL
               			wget "$URL" -qO "$IMG" || rm $IMG
        		fi
echo "[Desktop Entry]
Version=1.0
Name=$DISCO
Comment=Album mÃºsical
TryExec=$PROGRAMA
Exec=$PROGRAMA  \"$DISCO\" \"$ARTISTA\"
Icon=$IMG
StartupNotify=true
Type=Application" > "$MUSICA/Artistas/$ARTISTA/$ID.desktop"

			ln -s "$MUSICA/Artistas/$ARTISTA/" "$MUSICA/$GENERO/" 2> /dev/null
		done
	done
done

exit

Quehaceres
==========

* codificacion URI a UTF8
* Primera letra en mayuscula
